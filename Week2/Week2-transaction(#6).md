# [백엔드 스터디 in 큐시즘 - D조] Week 2: 스프링의 전반적인 이해
## #6. 스프링이란 무엇인가

### 트랜잭션의 필요성
트랜잭션이란 데이터베이스의 상태를 변경하는 작업 또는 한번에 수행되어야 하는 연산들을 의미한다. 스프링에서는 여러 작업을 진행하다가 문제가 생겼을 경우 이전 상태로 롤백하기 위해 주로 사용된다.

트랜잭션은 더 이상 쪼갤 수 없는 최소 작업 단위를 의미한다. 그래서 트랜잭션은 commit으로 성공 하거나 rollback으로 실패 이후 취소되어야 한다. 하지만 모든 트랜잭션이 동일한 것은 아니고 속성에 따라 동작 방식을 다르게 해줄 수 있다. 

예를 들어 1개의 새로운 데이터를 추가하는 와중에 에러가 발생하면 해당 추가 작업은 없었던 것처럼 되돌려진다. 하지만 만약 여러 개의 작업에 대해 롤백을 하려면 어떻게 해야 될까? 여러 개의 작업을 1개의 트랜잭션으로 관리해야 할 것이다.
위에서 설명한 것과 마찬가지로 트랜잭션의 마무리 작업으로는 크게 2가지가 있다.

- 트랜잭션 커밋: 작업이 마무리 됨
- 트랜잭션 롤백: 작업을 취소하고 이전의 상태로 돌림

만약 여러 작업이 모두 마무리 되었다면 트랜잭션 커밋을 통해 작업이 마무리되었음을 알려주어 반영해야 하며, 만약 문제가 생겼다면 작업 취소를 위해 트랜잭션 롤백 처리를 해주어야 한다.

### 트랜잭션 핵심 기술
Spring은 트랜잭션과 관련된 3가지 핵심 기술을 제공하고 있다. 그 3가지 핵심 기술은 다음과 같다.

**트랜잭션(Transaction) 동기화**
Spring은 여러 개의 작업을 하나의 트랜잭션으로 관리할 때 효율적으로 관리하고자 트랜잭션 동기화(Transaction Synchronization) 기술을 제공하고 있다. 트랜잭션 동기화는 트랜잭션을 시작하기 위한 Connection 객체를 특별한 저장소에 보관해두고 필요할 때 꺼내쓸 수 있도록 하는 기술이다.
트랜잭션 동기화 저장소는 작업 쓰레드마다 Connection 객체를 독립적으로 관리하기 때문에, 멀티쓰레드 환경에서도 충돌이 발생할 여지가 없다. 그래서 다음과 같이 트랜잭션 동기화를 적용하게 된다.

하지만 개발자가 JDBC가 아닌 Hibernate와 같은 기술을 쓴다면 위의 JDBC 종속적인 트랜잭션 동기화 코드들은 문제를 유발하게 된다. 대표적으로 Hibernate에서는 Connection이 아닌 Session이라는 객체를 사용하기 때문이다. 이러한 기술 종속적인 문제를 해결하기 위해 Spring은 트랜잭션 관리 부분을 추상화한 기술을 제공하고 있다.

**트랜잭션(Transaction) 추상화**
Spring은 트랜잭션 기술의 공통점을 담은 트랜잭션 추상화 기술을 제공하고 있다. 이를 이용함으로써 애플리케이션에 각 기술마다(JDBC, JPA, Hibernate 등) 종속적인 코드를 이용하지 않고도 일관되게 트랜잭션을 처리할 수 있도록 해주고 있다.

PlatformTransactionManager가 바로 그 추상형으로, 스프링 트랜잭션 매니저의 핵심 인터페이스이다. 모든 트랜잭션 매니저는 PlatformTransactionManager을 구현한다.
 
트랜잭션을 관리할 매니저 객체의 추상형을 제작해두었기 때문에, 사용할 데이터베이스 및 데이터 액세스 기술이 달라도 일관되게 형식으로 적용할 수 있다.

**+ TransactionManager 종류**
- DataSourceTransactionManager
: JDBC 및 MyBatis 등의 JDBC 기반 라이브러리로 데이터베이스에 접근하는 경우에 이용한다. 이 트랜잭션 매니저를 사용하려면 트랜잭션을 적용할 DataSource가 스프링의 빈으로 등록되어야 한다.
 
- HibernateTransactionManager
: 하이버네이트를 이용해 데이터베이스에 접근하는 경우에 이용한다.
 
- JpaTransactionManager
: JPA로 데이터베이스에 접근하는 경우에 이용한다. JpaTransactionManager는 LocalContainerEntityManagerFactoryBean타입의 빈을 등록해주어야한다.

- JtaTransactionManager
: 하나 이상의 DB 나 글로벌 트랜잭션을 적용하려면 JTA 이용할 수 있다. JTA는 여러 개의 트랜잭션 리소스(DB, JMS 등)에 대한 작업을 하나의 트랜잭션으로 묶을 수 있고, 여러 대의 서버에 분산되어 진행되는 작업을 트랜잭션으로 연결해주기도 한다.

**AOP를 이용한 트랜잭션(Transaction) 분리**
트랜잭션 코드와 비지니스 로직 코드가 복잡하게 얽혀있는 코드에서 마치 트랜잭션 코드와 같은 부가 기능 코드가 존재하지 않는 것 처럼 보이기 위해 해당 로직을 클래스 밖으로 빼내서 별도의 모듈로 만드는 AOP(Aspect Oriented Programming, 관점 지향 프로그래밍)를 고안 및 적용하게 되었고, 이를 적용한 트랜잭션 어노테이션(@Transactional)을 지원하게 되었다. 

### 트랜잭션의 성질
트랜잭션은 4가지의 성질을 가지고 있다. 이는 ACID 원칙이라고 하는데, 아주 기본적이고 중요한 개념이다.

- 원자성(Atomicity)
*한 트랜잭션 내에서 실행한 작업들은 하나로 간주한다(=하나의 단위로 처리한다.)*
즉, 모두 성공 또는 모두 실패하는 것을 의미.

- 일관성(Consistency)
*트랜잭션은 일관성 있는 데이타베이스 상태를 유지한다. (data integrity 만족 등.)*
제약조건이나 데이터 규칙에 위반하지 않는 일관성을 의미한다.
하나의 동작이 정상적인 흐름을 일관적으로 가질 수 있어야 한다는 원칙이다.

- 격리성(Isolation) 혹은 독립성
*동시에 실행되는 트랜잭션들이 서로 영향을 미치지 않도록 격리(=독립)해야한다.*
하나의 동작 중 다른 트랜잭션의 개입으로 데이터가 변경되지 않도록 한 동작이 독립적으로 처리해야한다는 원칙이다.

- 지속성(Durability)
*트랜잭션을 성공적으로 마치면 결과가 항상 저장되어야 한다.*
트랜잭션의 동작이 성공 후 Commit 된다면 영원히 반영되어야 한다는 원칙이다.


### 트랜잭션의 실제 사용
스프링에서는 트랜잭션 처리를 지원하는데 그중 어노테이션 방식으로 `@Transactional`을 선언하여 사용하는 방법이 일반적이며, `선언적 트랜잭션이라 부른다`
.클래스, 메서드위에 `@Transactional` 이 추가되면, 이 클래스에 트랜잭션 기능이 적용된 프록시 객체가 생성된다. 이 프록시 객체는 `@Transactional`이 포함된 메소드가 호출 될 경우, `PlatformTransactionManager`를 사용하여 트랜잭션을 시작하고, 정상 여부에 따라 Commit 또는 Rollback 한다.

### 트랜잭션의 세부 설정
Spring의 DefaultTransactionDefinition이 구현하고 있는 TransactionDefinition 인터페이스는 트랜잭션의 동작방식에 영향을 줄 수 있는 네 가지 속성을 정의하고 있다. 해당 4가지 속성은 트랜잭션을 세부적으로 이용할 수 있게 도와주며, `@Transactional` 어노테이션에도 공통적으로 적용할 수 있다. 

- 트랜잭션 전파
트랜잭션 전파란 트랜잭션의 경계에서 이미 진행중인 트랜잭션이 있거나 없을 때 어떻게 동작할 것인가를 결정하는 방식을 의미한다. 예를 들어 어떤 A 작업에 대한 트랜잭션이 진행중이고 B 작업이 시작될 때 B 작업에 대한 트랜잭션을 어떻게 처리할까에 대한 부분이다.
- 격리수준
모든 DB 트랜잭션은 격리수준을 가지고 있어야 한다. 서버에서는 여러 개의 트랜잭션이 동시에 진행될 수 있는데, 모든 트랜잭션을 독립적으로 만들고 순차 진행 한다면 안전하겠지만 성능이 크게 떨어질 수 밖에 없다. 따라서 적절하게 격리수준을 조정해서 가능한 많은 트랜잭션을 동시에 진행시키면서 문제가 발생하지 않도록 제어해야 한다.
- 제한시간
트랜잭션을 수행하는 제한시간을 설정할 수 있다. 제한시간의 설정은 트랜잭션을 직접 시작하는 PROPAGATION_REQUIRED나 PROPAGATION_REQUIRES_NEW의 경우에 사용해야만 의미가 있다.
- 읽기전용
읽기전용으로 설정해두면 트랜잭션 내에서 데이터를 조작하는 시도를 막아줄 수 있을 뿐만 아니라 데이터 액세스 기술에 따라 성능이 향상될 수 있다.


참고한 블로그
<br>
[MangKyu's Diary:티스토리](https://mangkyu.tistory.com/154)
<br>
[갓대희의 작은공간:티스토리](https://goddaehee.tistory.com/167)
<br>
[mirrorline:티스토리](https://gngsn.tistory.com/152)